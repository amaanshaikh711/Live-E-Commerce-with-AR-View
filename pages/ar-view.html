<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Experience</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Model Viewer -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.5.0/model-viewer.min.js"></script>

    <style>
        :root {
            --primary: #000000;
            --accent: #2563eb;
            --glass: rgba(255, 255, 255, 0.9);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #f5f5f5;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
            /* Let clicks pass through to viewer */
        }

        .back-btn {
            background: var(--glass);
            border: 1px solid rgba(0, 0, 0, 0.1);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 18px;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .back-btn:active {
            transform: scale(0.9);
        }

        .logo-mark {
            font-weight: 700;
            font-size: 16px;
            color: var(--primary);
            background: var(--glass);
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* Viewer Container */
        .viewer-container {
            flex: 1;
            position: fixed;
            /* Fixed to prevent scrolling behavior on mobile */
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
            background: radial-gradient(circle at center, #ffffff 0%, #e5e5e5 100%);
        }

        model-viewer {
            width: 100%;
            height: 100%;
            --poster-color: transparent;
        }

        /* Controls Area */
        .controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 0 20px 40px 20px;
            /* background: linear-gradient(to top, rgba(0, 0, 0, 0.05), transparent); */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            z-index: 100;
            pointer-events: none;
        }

        .product-card {
            background: var(--glass);
            padding: 15px 20px;
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            pointer-events: auto;
            margin-bottom: 80px;
            /* Space for the button */
        }

        .product-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .product-hint {
            font-size: 13px;
            color: #666;
        }

        /* AR Button */
        .ar-btn {
            position: absolute;
            bottom: 30px;
            bottom: calc(30px + env(safe-area-inset-bottom));
            /* iOS Safe Area */
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            border: none;
            padding: 18px 32px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            pointer-events: auto;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 90%;
            max-width: 300px;
            justify-content: center;
            z-index: 1000;
            white-space: nowrap;
        }

        .ar-btn:active {
            transform: translateX(-50%) scale(0.98);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .ar-btn i {
            font-size: 20px;
        }

        /* Status Messages */
        .status-toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 14px;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .status-toast.show {
            opacity: 1;
        }
    </style>
</head>

<body>

    <div class="header">
        <button class="back-btn" onclick="history.back()">
            <i class="fas fa-arrow-left"></i>
        </button>
        <div class="logo-mark">LUSSO HOMES AR</div>
    </div>


    <div class="viewer-container">
        <model-viewer id="ar-viewer" camera-controls shadow-intensity="1" loading="eager" ar
            ar-modes="webxr scene-viewer quick-look" ar-scale="auto" ar-placement="floor" interaction-prompt="none"
            src="" ios-src="" alt="3D Model" poster="" reveal="auto">

            <!-- Native AR Button (Handled by model-viewer) -->
            <button slot="ar-button" class="ar-btn" id="ar-element-btn">
                <i class="fas fa-camera"></i>
                <span>View in Your Room</span>
            </button>

            <!-- Loading Indicator -->
            <div id="loading-spinner" slot="progress-bar"
                style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: rgba(0,0,0,0.5); display: flex; flex-direction: column; align-items: center; gap: 10px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 32px;"></i>
                <div style="font-size: 14px; color: rgba(0,0,0,0.6);">Loading 3D Model...</div>
            </div>
        </model-viewer>

        <!-- Controls container for text only -->
        <div class="controls" style="pointer-events: none;">
            <div class="product-card" style="pointer-events: auto;">
                <div class="product-name" id="p-name">Loading...</div>
                <div class="product-hint">Rotate with one finger â€¢ Zoom with two</div>
            </div>
            <!-- Button is now inside model-viewer -->
        </div>
    </div>

    <div class="status-toast" id="toast"></div>

    <script src="../js/products.js"></script>
    <script>
        // Logic
        const params = new URLSearchParams(window.location.search);
        const pid = parseInt(params.get('id'));
        const product = products.find(p => p.id === pid);
        const viewer = document.getElementById('ar-viewer');

        function showToast(msg, duration = 3000) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), duration);
        }

        if (product) {
            document.getElementById('p-name').textContent = product.name;

            // Check if this product uses the default astronaut model
            const isAstronautModel = product.model && (
                product.model.includes('Astronaut.glb') ||
                product.model.includes('NeilArmstrong.glb')
            );

            // Set poster image
            if (product.image) {
                // Fix image path if needed
                let imgPath = product.image;
                if (!imgPath.startsWith('http') && !imgPath.startsWith('../')) {
                    // specific hack for Lusso structure: img/ is at root, we are in pages/
                    imgPath = '../' + imgPath;
                }
                viewer.poster = imgPath;
            }

            // If using astronaut model, show coming-soon image instead
            if (isAstronautModel) {
                // Set the coming-soon image as the poster
                viewer.poster = '../img/coming-soon.png';

                // Hide the AR button since there's no real 3D model
                const arBtn = document.getElementById('ar-element-btn');
                if (arBtn) {
                    arBtn.style.display = 'none';
                }

                // Update the hint text
                const hintElement = document.querySelector('.product-hint');
                if (hintElement) {
                    hintElement.textContent = '3D Model Coming Soon';
                }

                // Don't load the astronaut model
                viewer.removeAttribute('src');
                viewer.removeAttribute('ios-src');

            } else {
                // Fix URL paths for custom models
                let mUrl = product.model;
                // Handle models/ path which is at root
                if (mUrl && mUrl.startsWith('models/')) mUrl = '../' + mUrl;

                if (mUrl) {
                    // Full Absolute URL for reliability
                    const absUrl = new URL(mUrl, document.baseURI).href;
                    viewer.src = absUrl;
                    viewer.alt = `3D model of ${product.name}`;
                } else {
                    showToast("No 3D model available for this product");
                }

                if (product.iosModel) {
                    let iUrl = product.iosModel;
                    if (iUrl.startsWith('models/')) iUrl = '../' + iUrl;
                    viewer.setAttribute('ios-src', new URL(iUrl, document.baseURI).href);
                }
            }
        } else {
            showToast("Product not found");
        }

        // Handle errors
        viewer.addEventListener('error', (e) => {
            console.error('Model Viewer Error:', e);
            showToast("Error loading 3D model. Check connection.");
            // Hide loading spinner on error
            const spinner = document.getElementById('loading-spinner');
            if (spinner) spinner.style.display = 'none';
        });

        // Hide loading spinner when model is loaded
        viewer.addEventListener('load', () => {
            console.log('Model loaded successfully');
            const spinner = document.getElementById('loading-spinner');
            if (spinner) spinner.style.display = 'none';
        });

        // Also listen for poster-dismissed event (when user interacts with model)
        viewer.addEventListener('poster-dismissed', () => {
            const spinner = document.getElementById('loading-spinner');
            if (spinner) spinner.style.display = 'none';
        });

        // Listen for progress events to ensure spinner hides at 100%
        viewer.addEventListener('progress', (event) => {
            const progress = event.detail.totalProgress;
            if (progress === 1) {
                // Model is fully loaded
                setTimeout(() => {
                    const spinner = document.getElementById('loading-spinner');
                    if (spinner) spinner.style.display = 'none';
                }, 100);
            }
        });

        // AR Activation is now handled natively by the <model-viewer> component via slot="ar-button"
        // This ensures better compatibility with WebXR and fallback modes automatically.

        function forceAndroidIntent() {
            const url = viewer.src;
            if (!url) {
                showToast("Model URL not set");
                return;
            }

            const title = product ? product.name : 'Object';

            // Android Intent for ARCore Scene Viewer
            // Using logic that forces the browser to open the intent
            // resizable=false and mode=ar_only or ar_preferred

            const intentParams = new URLSearchParams();
            intentParams.append('file', url);
            intentParams.append('mode', 'ar_preferred');
            intentParams.append('title', title);
            intentParams.append('link', window.location.href);
            intentParams.append('resizable', 'false');

            // Construct Intent URI
            // S.browser_fallback_url ensures if it fails, it goes to Google Developers AR page
            const intent = `intent://arvr.google.com/scene-viewer/1.0?${intentParams.toString()}#Intent;scheme=https;package=com.google.android.googlequicksearchbox;action=android.intent.action.VIEW;S.browser_fallback_url=https://developers.google.com/ar;end;`;

            console.log("Launching Intent:", intent);

            // Create and click anchor
            const anchor = document.createElement('a');
            anchor.setAttribute('href', intent);
            anchor.click();
        }

        function showSecurityModal() {
            // Remove existing if any
            const existing = document.getElementById('sec-modal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = 'sec-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:30px;color:white;text-align:center;backdrop-filter:blur(10px);animation:fadeIn 0.3s ease;';

            const currentOrigin = `${window.location.protocol}//${window.location.hostname}:${window.location.port}`;

            modal.innerHTML = `
                <div style="background:rgba(255,255,255,0.1);padding:20px;border-radius:50%;margin-bottom:20px;">
                    <i class="fas fa-lock" style="font-size:40px;color:#f87171;"></i>
                </div>
                <h2 style="margin-bottom:10px;font-size:24px;">Camera Security Block</h2>
                <p style="margin-bottom:25px;line-height:1.6;color:#d1d5db;font-size:16px;">
                    Android blocks the AR Camera on local networks (192.168...).
                    <br>You need to allow this connection.
                </p>
                <div style="background:#262626;padding:20px;border-radius:16px;text-align:left;width:100%;max-width:320px;margin-bottom:25px;border:1px solid #404040;">
                    <div style="margin-bottom:10px;color:#9ca3af;font-size:14px;text-transform:uppercase;letter-spacing:1px;font-weight:bold;">How to fix (1 min):</div>
                    <div style="margin-bottom:8px;">1. Open <b>chrome://flags</b></div>
                    <div style="margin-bottom:8px;">2. Search <b>insecure origins</b></div>
                    <div style="margin-bottom:8px;">3. Set to <b>Enabled</b></div>
                    <div style="margin-bottom:8px;">4. Add this text:</div>
                    <div style="background:black;padding:10px;border-radius:8px;font-family:monospace;color:#4ade80;margin:5px 0;word-break:break-all;">${currentOrigin}</div>
                    <div>5. Relaunch Chrome</div>
                </div>
                <div style="display:flex;gap:10px;width:100%;max-width:320px;">
                    <button onclick="document.getElementById('sec-modal').remove()" style="flex:1;background:transparent;color:white;border:1px solid #404040;padding:14px;border-radius:12px;font-weight:600;">Close</button>
                    <button onclick="forceAndroidIntent()" style="flex:1;background:#2563eb;color:white;border:none;padding:14px;border-radius:12px;font-weight:600;">Try Anyway</button>
                </div>
            `;

            document.body.appendChild(modal);

            // Add fade animation
            const style = document.createElement('style');
            style.innerHTML = `@keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }`;
            document.head.appendChild(style);
        }
    </script>
    <script src="../js/products.js"></script>
    <script src="../js/main.js"></script>
    <script src="../js/scroll-animations.js"></script>
</body>

</html>